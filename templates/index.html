<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>International Brain Bee Training Bot</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.0/dist/js.cookie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #000000;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --accent-color: #000000;
            --hover-color: #e9ecef;
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
        }

        [data-theme="dark"] {
            --bg-primary: #000000;
            --bg-secondary: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #adb5bd;
            --border-color: #343a40;
            --accent-color: #ffffff;
            --hover-color: #2d2d2d;
            --shadow: 0 2px 4px rgba(255, 255, 255, 0.1);
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: all 0.3s ease;
            margin: 0;
            padding: 0;
        }

        .header {
            background: var(--bg-secondary);
            padding: 30px 0;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .header p {
            margin: 10px 0 0 0;
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .content-area {
            padding: 40px 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            overflow: hidden;
        }

        .card-header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-body {
            padding: 25px;
        }

        .form-select {
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 12px;
            font-size: 1rem;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .form-select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 0.2rem rgba(0, 0, 0, 0.1);
            outline: none;
        }

        .btn {
            border-radius: var(--border-radius);
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 2px solid var(--accent-color);
            background: var(--bg-primary);
            color: var(--accent-color);
        }

        .btn:hover {
            background: var(--accent-color);
            color: var(--bg-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn:disabled {
            opacity: 0.6;
            transform: none !important;
        }

        .btn-primary {
            background: var(--accent-color);
            color: var(--bg-primary);
            border-color: var(--accent-color);
        }

        .btn-primary:hover {
            background: var(--bg-primary);
            color: var(--accent-color);
        }

        .btn-success {
            background: var(--accent-color);
            color: var(--bg-primary);
            border-color: var(--accent-color);
        }

        .btn-success:hover {
            background: var(--bg-primary);
            color: var(--accent-color);
        }

        .btn-info {
            background: var(--bg-primary);
            color: var(--accent-color);
            border-color: var(--accent-color);
        }

        .btn-info:hover {
            background: var(--accent-color);
            color: var(--bg-primary);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.3);
            border-radius: 50%;
            border-top-color: var(--accent-color);
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .question-container {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 30px;
            margin: 30px 0;
            border-left: 4px solid var(--accent-color);
        }

        .question-text {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .options-container {
            display: grid;
            gap: 15px;
            margin: 25px 0;
        }

        .option-item {
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .option-item:hover {
            border-color: var(--accent-color);
            transform: translateX(5px);
            box-shadow: var(--shadow);
        }

        .option-item.selected {
            border-color: var(--accent-color);
            background: var(--hover-color);
        }

        .option-item.correct {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
        }

        .option-item.incorrect {
            border-color: #dc3545;
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
        }

        .option-item.correct .option-letter {
            background: #28a745;
            color: white;
        }

        .option-item.incorrect .option-letter {
            background: #dc3545;
            color: white;
        }

        .option-item input[type="radio"] {
            display: none;
        }

        .option-label {
            display: flex;
            align-items: center;
            font-weight: 500;
            color: var(--text-primary);
        }

        .option-letter {
            background: var(--accent-color);
            color: var(--bg-primary);
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 20px;
        }

        .feedback-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 25px;
            margin: 30px 0;
            border-left: 4px solid var(--accent-color);
            position: relative;
            overflow: hidden;
        }

        .feedback-correct {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border: 2px solid #28a745;
            border-left: 6px solid #28a745;
            color: #155724;
        }

        .feedback-incorrect {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            border: 2px solid #dc3545;
            border-left: 6px solid #dc3545;
            color: #721c24;
        }

        .feedback-correct::before {
            content: "✅ CORRECT!";
            position: absolute;
            top: 0;
            right: 0;
            background: #28a745;
            color: white;
            padding: 8px 15px;
            font-weight: bold;
            font-size: 0.9rem;
            border-radius: 0 var(--border-radius) 0 var(--border-radius);
        }

        .feedback-incorrect::before {
            content: "❌ INCORRECT";
            position: absolute;
            top: 0;
            right: 0;
            background: #dc3545;
            color: white;
            padding: 8px 15px;
            font-weight: bold;
            font-size: 0.9rem;
            border-radius: 0 var(--border-radius) 0 var(--border-radius);
        }

        [data-theme="dark"] .feedback-correct {
            background: linear-gradient(135deg, #1e4d2b, #2d5a3d);
            border-color: #28a745;
            color: #d4edda;
        }

        [data-theme="dark"] .feedback-incorrect {
            background: linear-gradient(135deg, #4d1e1e, #5a2d2d);
            border-color: #dc3545;
            color: #f8d7da;
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 30px 0;
            justify-content: center;
        }

        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .feedback-correct {
            animation: correctPulse 0.6s ease-in-out;
        }

        .feedback-incorrect {
            animation: incorrectShake 0.6s ease-in-out;
        }

        .history-item {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 25px;
            margin: 20px 0;
            border-left: 4px solid var(--accent-color);
            box-shadow: var(--shadow);
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 25px;
            text-align: center;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--accent-color);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-top: 10px;
        }

        .alert {
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            padding: 20px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .footer {
            background: var(--bg-secondary);
            padding: 30px;
            text-align: center;
            border-top: 1px solid var(--border-color);
            margin-top: 50px;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-primary);
            border: 2px solid var(--accent-color);
            color: var(--accent-color);
            padding: 10px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .theme-toggle:hover {
            background: var(--accent-color);
            color: var(--bg-primary);
        }

        .feature-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .text-primary {
            color: var(--accent-color);
        }

        .text-info {
            color: #17a2b8;
        }

        .text-secondary {
            color: #6c757d;
        }

        .flashcard-answer-content {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 20px;
            margin: 15px 0;
            border-left: 4px solid var(--accent-color);
        }

        .flashcard-answer-content.flashcard-correct {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
        }

        .flashcard-answer-content.flashcard-incorrect {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
        }

        .answer-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 4px;
        }

        .answer-label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .answer-value {
            font-weight: bold;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 1.1rem;
        }

        .answer-value.correct {
            background: #28a745;
            color: white;
        }

        .answer-value.incorrect {
            background: #dc3545;
            color: white;
        }

        .feedback-text {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 4px;
            border-left: 3px solid var(--accent-color);
            font-style: italic;
        }

        [data-theme="dark"] .flashcard-answer-content.flashcard-correct {
            background: linear-gradient(135deg, #1e4d2b, #2d5a3d);
        }

        [data-theme="dark"] .flashcard-answer-content.flashcard-incorrect {
            background: linear-gradient(135deg, #4d1e1e, #5a2d2d);
        }

        [data-theme="dark"] .answer-row {
            background: rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] .feedback-text {
            background: rgba(0, 0, 0, 0.3);
        }


        @media (max-width: 768px) {
            .header h1 { font-size: 2rem; }
            .content-area { padding: 20px; }
            .button-group { flex-direction: column; }
            .options-container { grid-template-columns: 1fr; }
            .theme-toggle { top: 10px; right: 10px; }
            .feature-card { margin-bottom: 20px; }
            .feature-card:last-child { margin-bottom: 0; }
        }
    </style>
    
    <script>
        $(document).ready(function() {
            let currentState = 'idle'; // idle, question, answered
            
            // Theme management
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon();
            
            function toggleTheme() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon();
            }
            
            function updateThemeIcon() {
                const theme = document.documentElement.getAttribute('data-theme');
                const icon = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
                $('#theme-toggle-icon').attr('class', icon);
            }
            
            $('#theme-toggle').on('click', toggleTheme);
            
            function setState(newState) {
                currentState = newState;
                updateUI();
            }
            
            function updateUI() {
                switch(currentState) {
                    case 'idle':
                        $('#new-question-btn').show().removeClass('hidden');
                        $('#submit-answer-btn').addClass('hidden');
                        $('#question-container').addClass('hidden');
                        $('#feedback-container').addClass('hidden');
                        break;
                    case 'question':
                        $('#new-question-btn').addClass('hidden');
                        $('#submit-answer-btn').show().removeClass('hidden');
                        $('#question-container').show().removeClass('hidden');
                        $('#feedback-container').addClass('hidden');
                        break;
                    case 'answered':
                        $('#new-question-btn').show().removeClass('hidden');
                        $('#submit-answer-btn').addClass('hidden');
                        $('#question-container').show().removeClass('hidden');
                        $('#feedback-container').show().removeClass('hidden');
                        break;
                }
            }

            function showLoading(button, text) {
                button.prop('disabled', true);
                button.html('<span class="loading-spinner"></span>' + text);
            }

            function hideLoading(button, originalText) {
                button.prop('disabled', false);
                button.text(originalText);
            }

            function colorCodeOptions(userAnswer, correctAnswer) {
                console.log('Color coding with:', { userAnswer, correctAnswer });
                console.log('All option items:', $('.option-item').length);
                
                $('.option-item').each(function(index) {
                    const $option = $(this);
                    const optionLetter = $option.find('.option-letter').text();
                    console.log(`Option ${index + 1}: letter="${optionLetter}", userAnswer="${userAnswer}", correctAnswer="${correctAnswer}"`);
                    
                    // Remove existing classes
                    $option.removeClass('correct incorrect');
                    
                    // Add appropriate class - prioritize correct answer
                    if (optionLetter === correctAnswer) {
                        console.log('✅ Marking as correct:', optionLetter);
                        $option.addClass('correct');
                    } else if (optionLetter === userAnswer && userAnswer !== correctAnswer) {
                        console.log('❌ Marking as incorrect:', optionLetter);
                        $option.addClass('incorrect');
                    } else {
                        console.log('⚪ Keeping neutral:', optionLetter);
                    }
                });
            }

            function updateConversation(data) {
                if (data.question) {
                    // Show question
                    $('#question-text').text(data.question);
                    $('#question-container').removeClass('hidden').addClass('fade-in');
                    setState('question');
                    
                    // Render options
                    $('#options-container').empty();
                    if (data.choices && data.choices.length === 4) {
                        data.choices.forEach(function(choice, idx) {
                            var match = choice.match(/^Option ([A-D]):\s*(.*)$/);
                            if (match) {
                                var letter = match[1];
                                var text = match[2];
                                var optionHtml = `
                                    <div class="option-item" data-value="${letter}">
                                        <input type="radio" name="answer" value="${letter}" id="option-${letter}">
                                        <label class="option-label" for="option-${letter}">
                                            <div class="option-letter">${letter}</div>
                                            <span>${text}</span>
                                        </label>
                                    </div>
                                `;
                                $('#options-container').append(optionHtml);
                            }
                        });
                    }
                }

                if (data.feedback) {
                    // Show feedback
                    $('#feedback-text').html(data.feedback);
                    $('#feedback-container').removeClass('hidden').addClass('fade-in');
                    
                    // Add correct/incorrect styling
                    const feedbackText = data.feedback.toLowerCase();
                    if (feedbackText.startsWith('correct!')) {
                        $('#feedback-container').removeClass('feedback-incorrect').addClass('feedback-correct');
                    } else {
                        $('#feedback-container').removeClass('feedback-correct').addClass('feedback-incorrect');
                    }
                    
                    // Color code the options - get correct answer from response
                    const userAnswer = $('input[name="answer"]:checked').val();
                    const correctAnswer = data.correct_answer;
                    console.log('Practice - User answer:', userAnswer, 'Correct answer:', correctAnswer);
                    if (userAnswer && correctAnswer) {
                        colorCodeOptions(userAnswer, correctAnswer);
                    }
                    
                    setState('answered');
                    
                    // Update stats
                    updateStats();
                }
            }

            function updateStats() {
                // This would be implemented with actual stats from the backend
                // For now, we'll just show placeholder stats
                $('#stats-container').html(`
                    <div class="stat-card">
                        <div class="stat-number">5</div>
                        <div class="stat-label">Questions Answered</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">80%</div>
                        <div class="stat-label">Accuracy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">3</div>
                        <div class="stat-label">Categories Tried</div>
                    </div>
                `);
            }

            function displayHistory(history) {
                $('#review-history-content').empty();
                if (history.length === 0) {
                    $('#review-history-content').html('<p class="text-muted">No questions answered yet. Start practicing!</p>');
                    return;
                }
                
                $.each(history, function(index, item) {
                    var isCorrect = item.user_answer === item.correct_answer;
                    var historyHtml = `
                        <div class="history-item">
                            <div class="question-text">${item.question}</div>
                            <div class="mt-3">
                                <strong>Your Answer:</strong> 
                                <span class="badge ${isCorrect ? 'bg-success' : 'bg-danger'}">${item.user_answer}</span>
                                <strong>Correct Answer:</strong> 
                                <span class="badge bg-primary">${item.correct_answer}</span>
                            </div>
                            <div class="mt-2">
                                <strong>Feedback:</strong> ${item.feedback}
                            </div>
                        </div>
                    `;
                    $('#review-history-content').append(historyHtml);
                });
            }

            // Option selection
            $(document).on('click', '.option-item', function() {
                $('.option-item').removeClass('selected');
                $(this).addClass('selected');
                $(this).find('input[type="radio"]').prop('checked', true);
            });

            // Submit answer
            $('#submit-answer-btn').on('click', function() {
                var selectedAnswer = $('input[name="answer"]:checked').val();
                if (!selectedAnswer) {
                    alert('Please select an answer first!');
                    return;
                }

                var $btn = $(this);
                var originalText = $btn.text();
                showLoading($btn, 'Submitting...');

                $.ajax({
                    url: '/update',
                    type: 'POST',
                    data: { answer: selectedAnswer },
                    dataType: 'json',
                    success: function(data) {
                        updateConversation(data);
                    },
                    error: function(xhr, status, error) {
                        alert("An error occurred: " + xhr.responseText);
                    },
                    complete: function() {
                        hideLoading($btn, originalText);
                    }
                });
            });

            // New question
            $('#new-question-btn').on('click', function() {
                var $btn = $(this);
                var selectedCategory = $('#category-dropdown').val();
                var originalText = $btn.text();
                
                showLoading($btn, 'Generating Question...');

                $.ajax({
                    url: '/new_question',
                    type: 'POST',
                    data: { category: selectedCategory },
                    dataType: 'json',
                    success: function(data) {
                        if (data.error) {
                            alert("Error: " + data.error);
                        } else {
                            updateConversation(data);
                        }
                    },
                    error: function(xhr, status, error) {
                        alert("An error occurred: " + xhr.responseText);
                    },
                    complete: function() {
                        hideLoading($btn, originalText);
                    }
                });
            });

            // Back to home from practice
            $('#back-to-home-btn').on('click', function() {
                $('#home-page').removeClass('hidden');
                $('#practice-section').addClass('hidden');
                $('#history-section').addClass('hidden');
                $('#flashcards-section').addClass('hidden');
            });

            // Back to home from history
            $('#back-to-home-btn-2').on('click', function() {
                $('#home-page').removeClass('hidden');
                $('#practice-section').addClass('hidden');
                $('#history-section').addClass('hidden');
                $('#flashcards-section').addClass('hidden');
            });

            // Back to home from flashcards
            $('#back-to-home-btn-3').on('click', function() {
                $('#home-page').removeClass('hidden');
                $('#practice-section').addClass('hidden');
                $('#history-section').addClass('hidden');
                $('#flashcards-section').addClass('hidden');
            });

            // Start practice
            $('#start-practice-btn').on('click', function() {
                var $btn = $(this);
                var originalText = $btn.text();
                var selectedCategory = $('#category-dropdown').val();
                
                showLoading($btn, 'Loading Practice...');

                $.ajax({
                    url: '/new_question',
                    type: 'POST',
                    data: { category: selectedCategory },
                    dataType: 'json',
                    success: function(data) {
                        if (data.error) {
                            alert("Error: " + data.error);
                        } else {
                            updateConversation(data);
                            $('#home-page').addClass('hidden');
                            $('#practice-section').removeClass('hidden');
                            $('#history-section').addClass('hidden');
                            $('#flashcards-section').addClass('hidden');
                        }
                    },
                    error: function(xhr, status, error) {
                        alert("An error occurred: " + xhr.responseText);
                    },
                    complete: function() {
                        hideLoading($btn, originalText);
                    }
                });
            });

            // Start flashcards
            $('#start-flashcards-btn').on('click', function() {
                var $btn = $(this);
                var originalText = $btn.text();
                
                showLoading($btn, 'Loading Flashcards...');

                $.ajax({
                    url: '/review_history',
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        flashcardHistory = data.history || [];
                        if (flashcardHistory.length === 0) {
                            alert('No questions in history to review as flashcards.');
                            hideLoading($btn, originalText);
                            return;
                        }
                        flashcardIndex = 0;
                        showFlashcard(flashcardIndex);
                        $('#home-page').addClass('hidden');
                        $('#practice-section').addClass('hidden');
                        $('#history-section').addClass('hidden');
                        $('#flashcards-section').removeClass('hidden');
                    },
                    error: function(xhr, status, error) {
                        alert("An error occurred: " + xhr.responseText);
                    },
                    complete: function() {
                        hideLoading($btn, originalText);
                    }
                });
            });

            // View history
            $('#view-history-btn').on('click', function() {
                var $btn = $(this);
                var originalText = $btn.text();
                
                showLoading($btn, 'Loading History...');

                $.ajax({
                    url: '/review_history',
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        displayHistory(data.history);
                        $('#home-page').addClass('hidden');
                        $('#practice-section').addClass('hidden');
                        $('#history-section').removeClass('hidden');
                        $('#flashcards-section').addClass('hidden');
                    },
                    error: function(xhr, status, error) {
                        alert("An error occurred: " + xhr.responseText);
                    },
                    complete: function() {
                        hideLoading($btn, originalText);
                    }
                });
            });

            // Clear session
            $('#clear-session-btn').on('click', function() {
                if (confirm('Are you sure you want to clear your session? This will reset all progress.')) {
                    var $btn = $(this);
                    var originalText = $btn.text();
                    
                    showLoading($btn, 'Clearing...');

                    $.ajax({
                        url: '/clear_session',
                        type: 'POST',
                        dataType: 'json',
                        success: function(data) {
                            alert('Session cleared successfully!');
                            location.reload();
                        },
                        error: function(xhr, status, error) {
                            alert("An error occurred: " + xhr.responseText);
                        },
                        complete: function() {
                            hideLoading($btn, originalText);
                        }
                    });
                }
            });

            // Initialize
            var initialQuizState = {{ quiz_state | tojson }};
            // Always start with the home page
            $('#home-page').removeClass('hidden');
            $('#practice-section').addClass('hidden');
            $('#history-section').addClass('hidden');
            $('#flashcards-section').addClass('hidden');
            
            // If there's an existing question, store it but don't show it automatically
            if (initialQuizState.question) {
                // Store the state for when user chooses to practice
                updateConversation(initialQuizState);
            } else {
                setState('idle');
            }

            let flashcardHistory = [];
            let flashcardIndex = 0;

            function showFlashcard(index) {
                if (!flashcardHistory.length) {
                    $('#flashcard-question').text('No questions in history.');
                    $('#flashcard-choices').empty();
                    $('#flashcard-answer').hide();
                    $('#show-flashcard-answer-btn').hide();
                    $('#flashcard-progress').text('');
                    return;
                }
                const item = flashcardHistory[index];
                $('#flashcard-question').text(item.question);
                let choicesHtml = '';
                if (item.choices && item.choices.length === 4) {
                    item.choices.forEach(function(choice) {
                        var match = choice.match(/^Option ([A-D]):\s*(.*)$/);
                        if (match) {
                            var letter = match[1];
                            var text = match[2];
                            choicesHtml += `<div class="option-item"><div class="option-letter">${letter}</div> <span>${text}</span></div>`;
                        }
                    });
                }
                $('#flashcard-choices').html(choicesHtml);
                
                // Create better formatted answer display
                const isCorrect = item.user_answer === item.correct_answer;
                const answerClass = isCorrect ? 'flashcard-correct' : 'flashcard-incorrect';
                const answerHtml = `
                    <div class="flashcard-answer-content ${answerClass}">
                        <div class="answer-row">
                            <span class="answer-label">Your Original Answer:</span>
                            <span class="answer-value ${isCorrect ? 'correct' : 'incorrect'}">${item.user_answer}</span>
                        </div>
                        <div class="answer-row">
                            <span class="answer-label">Correct Answer:</span>
                            <span class="answer-value correct">${item.correct_answer}</span>
                        </div>
                        <div class="feedback-text">${item.feedback}</div>
                    </div>
                `;
                $('#flashcard-answer').hide().html(answerHtml);
                $('#show-flashcard-answer-btn').show();
                $('#flashcard-progress').text(`Question ${index + 1} of ${flashcardHistory.length}`);
                
                // Reset color coding for new flashcard - no colors until "Show Answer" is clicked
                $('.option-item').removeClass('correct incorrect selected');
            }

            $('#show-flashcard-answer-btn').on('click', function() {
                $('#flashcard-answer').show();
                $(this).hide();
                
                // Color code the flashcard options based on the original answer from history
                const item = flashcardHistory[flashcardIndex];
                console.log('Flashcard item:', item);
                if (item) {
                    console.log('Original user answer:', item.user_answer);
                    console.log('Correct answer:', item.correct_answer);
                    // Show the original user's answer and the correct answer
                    colorCodeOptions(item.user_answer, item.correct_answer);
                }
            });

            $('#flashcard-next-btn').on('click', function() {
                if (flashcardHistory.length && flashcardIndex < flashcardHistory.length - 1) {
                    flashcardIndex++;
                    showFlashcard(flashcardIndex);
                }
            });

            $('#flashcard-prev-btn').on('click', function() {
                if (flashcardHistory.length && flashcardIndex > 0) {
                    flashcardIndex--;
                    showFlashcard(flashcardIndex);
                }
            });

            // Hide flashcards section when other buttons are clicked
            $('#new-question-btn, #view-history-btn, #clear-session-btn, #start-practice-btn, #start-flashcards-btn').on('click', function() {
                $('#flashcards-section').addClass('hidden');
            });
        });
    </script>
</head>
<body>
    <!-- Theme Toggle Button -->
    <button id="theme-toggle" class="theme-toggle">
        <i id="theme-toggle-icon" class="fas fa-moon"></i>
    </button>

            <!-- Header -->
        <div class="header">
            <h1>International Brain Bee Online Practice</h1>
            <p>Prepare for the brain bee with AI powered questions</p>
        </div>

        <!-- Main Content -->
        <div class="content-area">
            <!-- Home Page -->
            <div id="home-page">
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <div class="card h-100 feature-card" id="practice-card">
                            <div class="card-body text-center">
                                <i class="fas fa-brain fa-3x mb-3 text-primary"></i>
                                <h5 class="card-title">Practice Questions</h5>
                                <p class="card-text">Generate new Brain Bee style questions and test your knowledge across different neuroscience categories.</p>
                                <button class="btn btn-primary" id="start-practice-btn">
                                    <i class="fas fa-play"></i> Start Practice
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card h-100 feature-card" id="history-card">
                            <div class="card-body text-center">
                                <i class="fas fa-history fa-3x mb-3 text-info"></i>
                                <h5 class="card-title">Review History</h5>
                                <p class="card-text">Browse through all your previously answered questions with detailed feedback and explanations.</p>
                                <button class="btn btn-info" id="view-history-btn">
                                    <i class="fas fa-list"></i> View History
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card h-100 feature-card" id="flashcards-card">
                            <div class="card-body text-center">
                                <i class="fas fa-clone fa-3x mb-3 text-secondary"></i>
                                <h5 class="card-title">Flashcards Review</h5>
                                <p class="card-text">Review your answered questions as interactive flashcards. Test your memory by hiding answers.</p>
                                <button class="btn btn-secondary" id="start-flashcards-btn">
                                    <i class="fas fa-clone"></i> Start Flashcards
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Practice Section -->
            <div id="practice-section" class="hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-brain"></i> Practice Questions</h3>
                    <button class="btn btn-outline-primary" id="back-to-home-btn">
                        <i class="fas fa-home"></i> Back to Home
                    </button>
                </div>

                <!-- Category Selection -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-list"></i> Select Category
                    </div>
                    <div class="card-body">
                        <select class="form-select" id="category-dropdown">
                            <option value="Sensory system">Sensory system</option>
                            <option value="Neurology (Diseases of the Brain)">Neurology (Diseases of the Brain)</option>
                            <option value="Neuroanatomy">Neuroanatomy</option>
                            <option value="Neural communication (electrical and chemical)">Neural communication (electrical and chemical)</option>
                            <option value="Motor system">Motor system</option>
                            <option value="Higher cognition">Higher cognition</option>
                            <option value="Development of the nervous system">Development of the nervous system</option>
                            <option value="Cellular organization of the nervous system">Cellular organization of the nervous system</option>
                        </select>
                    </div>
                </div>

                <!-- Button Group -->
                <div class="button-group">
                    <button class="btn btn-primary" id="new-question-btn">
                        <i class="fas fa-plus"></i> New Question
                    </button>
                    <button class="btn btn-success hidden" id="submit-answer-btn">
                        <i class="fas fa-check"></i> Submit Answer
                    </button>
                    <button class="btn btn-warning" id="clear-session-btn">
                        <i class="fas fa-trash"></i> Clear Session
                    </button>
                </div>

                <!-- Stats Container -->
                <div id="stats-container" class="stats-container hidden"></div>

                <!-- Question Container -->
                <div id="question-container" class="question-container hidden">
                    <div class="question-text" id="question-text"></div>
                    <div class="options-container" id="options-container"></div>
                </div>

                <!-- Feedback Container -->
                <div id="feedback-container" class="feedback-container hidden">
                    <div id="feedback-text"></div>
                </div>
            </div>

            <!-- Review History Section -->
            <div id="history-section" class="hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-history"></i> Review History</h3>
                    <button class="btn btn-outline-primary" id="back-to-home-btn-2">
                        <i class="fas fa-home"></i> Back to Home
                    </button>
                </div>
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-history"></i> Question History
                    </div>
                    <div class="card-body">
                        <div id="review-history-content"></div>
                    </div>
                </div>
            </div>

            <!-- Flashcards Review Section -->
            <div id="flashcards-section" class="hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-clone"></i> Flashcards Review</h3>
                    <button class="btn btn-outline-primary" id="back-to-home-btn-3">
                        <i class="fas fa-home"></i> Back to Home
                    </button>
                </div>
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-clone"></i> Flashcards Review
                    </div>
                    <div class="card-body">
                        <div id="flashcard-question" class="question-text mb-3"></div>
                        <div id="flashcard-choices" class="mb-3"></div>
                        <button class="btn btn-info mb-3" id="show-flashcard-answer-btn">Show Answer</button>
                        <div id="flashcard-answer" class="mb-3" style="display:none;"></div>
                        <div class="d-flex justify-content-between">
                            <button class="btn btn-outline-primary" id="flashcard-prev-btn">Previous</button>
                            <span id="flashcard-progress" class="align-self-center text-muted"></span>
                            <button class="btn btn-outline-primary" id="flashcard-next-btn">Next</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notice -->
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Notice:</strong> Questions are powered by OpenAI and study materials like the Brain Bee Facts textbook.
            </div>
        </div>

    <!-- Footer -->
    <div class="footer">
        <p class="text-muted mb-0">
            Created by <strong>Ryan Cho</strong>. For inquiries, email 
            <a href="mailto:rcho@youthneuro.org">rcho@youthneuro.org</a>
        </p>
    </div>
</body>
</html>
